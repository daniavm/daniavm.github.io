<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Consejo premio al buen educador 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --color-primary:#A7282D; --color-primary-hover:#7f1f25; }
    body{ font-family:'Inter',sans-serif }
    .toast{ visibility:hidden; min-width:250px; background:#333; color:#fff; text-align:center; border-radius:8px; padding:16px; position:fixed; z-index:50; left:50%; bottom:30px; transform:translateX(-50%); opacity:0; transition:.5s }
    .toast.show{ visibility:visible; opacity:1; bottom:50px }
    .bg-primary{ background:var(--color-primary) } .hover\:bg-primary-hover:hover{ background:var(--color-primary-hover) }
    .focus\:ring-primary:focus{ box-shadow:0 0 0 4px var(--color-primary) } .focus\:border-primary:focus{ border-color:var(--color-primary) }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">
  <div class="container mx-auto p-4 md:p-8 max-w-3xl">
    <header class="text-center mb-8">
      <img id="logo" src="https://daniavm.github.io/assets/images/logoCSB.png" alt="Logo Institucional" class="mx-auto h-20 w-auto mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Consejo premio al buen educador 2025</h1>
      <p class="text-slate-600 mt-2">Te invitamos a participar de este importante proceso.</p>
    </header>

    <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-slate-200">
      <div id="userInfo" class="p-4 rounded-lg hidden mb-6"></div>

      <div id="loading" class="text-center p-8">
        <!-- SVG loader con viewBox correcto -->
        <svg class="animate-spin h-8 w-8 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <p class="mt-2 font-medium">Cargando datos...</p>
      </div>

      <div id="formContainer"></div>
      <div id="softError" class="hidden mt-4 p-4 rounded-lg border border-red-200 bg-red-50 text-red-800 text-sm"></div>
    </main>
  </div>
  <div id="toast" class="toast">¡Gracias! Tu voto ha sido registrado.</div>

  <script>
    // =================== CONFIG API (JSONP) ===================
    const GAS_BASE_URL = 'https://script.google.com/macros/s/AKfycbyrh-gOhjB7JKvEsKt5QQ3IOOxeJBQmwhVjfj91TrIjPIwMKiXKlOj0BrXQuk7ZSo1G-A/exec'; // <-- reemplaza por tu /exec
    const API_KEY = '';               // si configuraste SHARED_API_KEY en Apps Script
    const ALLOWED_DOMAIN = 'colegiosanbenito.org'; // dominio permitido (o '' para cualquiera)

    // JSONP helper
    function jsonp(url, timeoutMs = 15000) {
      return new Promise((resolve, reject) => {
        const cbName = 'jsonp_cb_' + Math.random().toString(36).slice(2);
        const script = document.createElement('script');
        const timer = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
        function cleanup(){ clearTimeout(timer); delete window[cbName]; if (script && script.parentNode) script.parentNode.removeChild(script); }
        window[cbName] = (data) => { cleanup(); resolve(data); };
        const sep = url.includes('?') ? '&' : '?';
        script.src = url + sep + 'callback=' + encodeURIComponent(cbName);
        script.onerror = () => { cleanup(); reject(new Error('JSONP error')); };
        document.head.appendChild(script);
      });
    }

    // Cliente API
    const api = {
      getSheetDataSafe() {
        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('fn','getSheetDataSafe');
        if (API_KEY) url.searchParams.set('key', API_KEY);
        return jsonp(url.toString());
      },
      hasVoted(email) {
        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('fn','hasVoted');
        url.searchParams.set('email', email);
        if (API_KEY) url.searchParams.set('key', API_KEY);
        return jsonp(url.toString());
      },
      saveVote(payload) {
        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('fn','saveVote');
        url.searchParams.set('payload', JSON.stringify(payload));
        if (API_KEY) url.searchParams.set('key', API_KEY);
        return jsonp(url.toString());
      }
    };

    // =================== UI HELPERS ===================
    const formContainer = document.getElementById('formContainer');
    const loading = document.getElementById('loading');
    const userInfo = document.getElementById('userInfo');
    const softError = document.getElementById('softError');
    const toast = document.getElementById('toast');

    function showError(msg){ softError.textContent = msg || 'Ocurrió un error'; softError.classList.remove('hidden'); }
    function hideError(){ softError.classList.add('hidden'); softError.textContent = ''; }
    function showToast(msg='¡Gracias! Tu voto ha sido registrado.'){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),3000); }
    function hexToRgba(hex, a=1){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m?`rgba(${parseInt(m[1],16)}, ${parseInt(m[2],16)}, ${parseInt(m[3],16)}, ${a})`:''; }

    // ====== Reglas de subáreas válidas ======
    const PROFESSOR_SUBAREAS_SOURCE = [
      'Lenguaje','Matemática','Música','Inglés secundaria','Ciencias','Ed. Física',
      'Inglés - 1° ciclo','Preescolar','Lenguaje','Inglés - 2° ciclo','Inglés Secundaria',
      'Matemática','Historia','1°- 2° Básico','Religión y Filosofía','Preescolar','Arte'
    ];
    const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[-–—]/g,' ').replace(/\s+/g,' ').trim();
    const PROFESSOR_SUBAREAS = new Set(PROFESSOR_SUBAREAS_SOURCE.map(norm));
    const isProfessorSubarea = s => PROFESSOR_SUBAREAS.has(norm(s));

    // =================== Datos y flujo ===================
    let allData = [];      // registros
    let indexByEmail = new Map();

    function normalizeEmail(s){ return String(s||'').trim().toLowerCase(); }
    function isAllowedDomain(email){
      if(!ALLOWED_DOMAIN) return true;
      const parts = normalizeEmail(email).split('@');
      return parts.length===2 && parts[1]===ALLOWED_DOMAIN;
    }

    function calcularAntiguedad(f){
      if(!f) return 0; const p=String(f).split(/[\/\-]/); let d;
      if(p.length===3){ d = (p[0].length===4) ? new Date(p[0],p[1]-1,p[2]) : new Date(p[2],p[1]-1,p[0]); } else return 0;
      const h=new Date(); let a=h.getFullYear()-d.getFullYear(); const m=h.getMonth()-d.getMonth(); if(m<0 || (m===0 && h.getDate()<d.getDate())) a--; return a;
    }

    function processData(arr){
      return (arr||[]).map(p=>{
        const nombreCompleto = `${p.nombre||''} ${p.primerApellido||''} ${p.segundoApellido||''}`.replace(/\s+/g,' ').trim();
        let rol = 'Indefinido'; if(String(p.grupo).trim()==='2') rol='Profesor de Sala'; else if(String(p.grupo).trim()==='1') rol='Educador';
        const _excluded = !!p.noSeIncluye; // viene marcado desde el backend
        return {...p, nombreCompleto, rolCalculado:rol, _excluded};
      }).filter(p => p.nombreCompleto && p.email);
    }

    function createSelectOptions(list){
      const usable=list.filter(p=>!p._excluded);
      if(!usable.length) return '<option value="">-- No hay candidatos disponibles --</option>';
      const sorted=[...usable].sort((a,b)=>a.nombreCompleto.localeCompare(b.nombreCompleto));
      let html='<option value="">-- Selecciona una persona --</option>';
      sorted.forEach(p=> html+=`<option value="${p.email}">${p.nombreCompleto}</option>`);
      return html;
    }
    function createSelectOptionsWithSubarea(list){
      const usable=list.filter(p=>!p._excluded);
      if(!usable.length) return '<option value="">-- No hay candidatos disponibles --</option>';
      const sorted=[...usable].sort((a,b)=>{
        const A=String(a.departamento||'').toLowerCase(), B=String(b.departamento||'').toLowerCase();
        if(A<B) return -1; if(A>B) return 1; return a.nombreCompleto.localeCompare(b.nombreCompleto);
      });
      let html='<option value="">-- Selecciona una persona --</option>';
      sorted.forEach(p=> html+=`<option value="${p.email}">${p.departamento||'(Sin subárea)'} — ${p.nombreCompleto}</option>`);
      return html;
    }

    function renderSuccessCard(nombre){
      formContainer.innerHTML = `
        <div class="text-center p-8 border-2 border-dashed border-emerald-200 rounded-2xl bg-emerald-50/70">
          <svg class="mx-auto mb-4 h-10 w-10 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12l2 2l4 -4m6 2a9 9 0 11-18 0a9 9 0 0118 0z"/>
          </svg>
          <h3 class="text-2xl font-semibold text-emerald-800">¡Gracias, ${nombre||'participante'}!</h3>
          <p class="text-slate-700 mt-2">Tu respuesta fue enviada correctamente.</p>
        </div>`;
    }

    function renderVotingForm(currentUser, userRole){
      const isMe = p => normalizeEmail(p.email)===normalizeEmail(currentUser.email);
      const elegible = allData.filter(p=> calcularAntiguedad(p.fechaIngreso)>=5 && !isMe(p) && !p._excluded);
      const profesores = elegible.filter(p=> p.rolCalculado==='Profesor de Sala' && isProfessorSubarea(p.departamento));
      const educadores = elegible.filter(p=> p.rolCalculado==='Educador');

      let html = '<form id="recognitionForm" class="space-y-6">';
      if(userRole==='Profesor'){
        const myDept = norm(currentUser.departamento);
        const mismos = profesores.filter(p=> norm(p.departamento)===myDept);
        const otros  = profesores.filter(p=> norm(p.departamento)!==myDept);
        html += `
          <div class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50/80">
            <p class="text-md font-semibold text-slate-800">Pregunta 1: Votación por Profesores</p>
            <div class="pl-2 border-l-4 border-primary/50 pt-1">
              <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-primary mr-1">1a.</strong>Profesor de tu departamento</label>
              <select name="vote1" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptions(mismos)}</select>
            </div>
            <div class="pl-2 border-l-4 border-primary/50 pt-1">
              <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-primary mr-1">1b.</strong>Profesor de otro departamento</label>
              <select name="vote2" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(otros)}</select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-slate-700 mr-1">2.</strong>EDUCADOR</label>
            <select name="vote3" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(educadores)}</select>
          </div>`;
      } else {
        html += `
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-slate-700 mr-1">1.</strong>PROFESOR</label>
            <select name="vote1" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(profesores)}</select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-slate-700 mr-1">2.</strong>EDUCADOR</label>
            <select name="vote2" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(educadores)}</select>
          </div>`;
      }
      html += `<button type="submit" id="voteButton" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-hover transition">Enviar Votación</button></form>`;
      formContainer.innerHTML = html;

      indexByEmail = new Map(allData.map(p=>[normalizeEmail(p.email), p]));

      document.getElementById('recognitionForm').addEventListener('submit', async (ev)=>{
        ev.preventDefault(); hideError();
        const f = ev.target;
        const v1 = f.vote1?.value||'', v2=f.vote2?.value||'', v3=f.vote3?.value||'';
        if(!v1 || !v2) return showError('Debes completar al menos las dos primeras selecciones.');
        const vals=[v1,v2].concat(v3?[v3]:[]); const lower=vals.map(x=>normalizeEmail(x));
        if(new Set(lower).size!==lower.length) return showError('Los votos deben ser por personas distintas.');
        if(lower.includes(normalizeEmail(currentUser.email))) return showError('No puedes votarte a ti mismo.');

        const pick = email => { const p=indexByEmail.get(normalizeEmail(email)); return p?{name:p.nombreCompleto,email:p.email,subarea:p.departamento}:null; };
        const d1=pick(v1), d2=pick(v2), d3=v3?pick(v3):null;
        const voter = { name:currentUser.nombreCompleto, email:currentUser.email, subarea:currentUser.departamento };

        const payload = {
          votanteEmail: voter.email,
          voto1: v1, voto2: v2, voto3: v3 || null,
          voter, details: [{slot:1,...d1},{slot:2,...d2}, ...(d3?[{slot:3,...d3}]:[])]
        };

        try {
          const resp = await api.saveVote(payload);
          if (!resp || resp.ok !== true) throw new Error(resp?.error || 'No se pudo guardar');
          showToast('¡Gracias! Tu voto ha sido registrado.');
          renderSuccessCard(voter.name); // oculta el formulario
        } catch (err) { showError('Error al guardar: ' + (err?.message || err)); }
      });
    }

    function renderLogin() {
      loading.classList.add('hidden');
      formContainer.innerHTML = `
        <div class="p-6 sm:p-8 rounded-2xl border border-slate-200 bg-white">
          <h3 class="text-xl font-semibold text-slate-900">Identifícate para votar</h3>
          <p class="text-slate-600 mt-2">Usa tu correo institucional para validar que estás en la lista.</p>

          <form id="loginForm" class="mt-6 space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Correo institucional</label>
              <input type="email" name="email" required placeholder="tucorreo@${ALLOWED_DOMAIN||'tu-dominio'}"
                class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" />
            </div>
            <button class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-hover transition">Continuar</button>
          </form>
          <div id="loginError" class="hidden mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-3"></div>
        </div>
      `;

      const form = document.getElementById('loginForm');
      const err  = document.getElementById('loginError');
      form.addEventListener('submit', (ev)=>{
        ev.preventDefault(); hideError(); err.classList.add('hidden'); err.textContent='';
        const email = normalizeEmail(new FormData(form).get('email')||'');
        handleLogin(email).catch(e=>{
          err.textContent = e?.message || 'No se pudo validar tu correo.';
          err.classList.remove('hidden');
        });
      });
    }

    async function handleLogin(email){
      if(!email) throw new Error('Ingresa un correo.');
      if(!isAllowedDomain(email)) throw new Error(`Debe ser @${ALLOWED_DOMAIN}.`);

      const me = allData.find(p => normalizeEmail(p.email) === email);
      if(!me){
        throw new Error(`Tu correo (${email}) no aparece en la lista.`);
      }

      localStorage.setItem('userEmail', email);

      userInfo.innerHTML = `<p><strong>Votando como:</strong> ${me.nombreCompleto} <span class="text-slate-500">(${me.email})</span></p>`;
      userInfo.style.backgroundColor = hexToRgba('#A7282D',0.08);
      userInfo.style.color = '#7f1f25';
      userInfo.classList.remove('hidden');

      // ¿Ya votó?
      try {
        const info = await api.hasVoted(email);
        if (info && info.voted) {
          formContainer.innerHTML = `
            <div class="text-center p-8 border-2 border-dashed border-emerald-200 rounded-lg bg-emerald-50/70">
              <h3 class="text-xl font-semibold text-emerald-800">¡Gracias!</h3>
              <p class="text-slate-700 mt-2">Ya registraste un voto el <strong>${info.lastAt}</strong>.</p>
            </div>`;
        } else {
          promptForRole(me);
        }
      } catch {
        promptForRole(me);
      }
    }

    function promptForRole(currentUser){
      formContainer.innerHTML = `
        <div class="text-center p-8 border-2 border-dashed border-slate-200 rounded-lg">
          <h3 class="text-xl font-semibold text-slate-800 mb-6">¿Eres profesor titular de alguna asignatura?</h3>
          <div class="flex justify-center gap-4">
            <button id="answerYes" class="w-24 bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-hover">Sí</button>
            <button id="answerNo" class="w-24 bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">No</button>
          </div>
        </div>`;
      document.getElementById('answerYes').onclick = ()=>renderVotingForm(currentUser,'Profesor');
      document.getElementById('answerNo').onclick  = ()=>renderVotingForm(currentUser,'Educador');
    }

    // =================== INIT ===================
    (async function init(){
      try {
        // 1) Obtener directorio
        const payload = await api.getSheetDataSafe();
        if(!payload || payload.ok!==true) throw new Error(payload?.error || 'Error de carga');
        allData = processData(payload.data || []);
        indexByEmail = new Map(allData.map(p=>[normalizeEmail(p.email), p]));
        loading.classList.add('hidden');

        // 2) Usuario por ?user= o localStorage
        const params = new URLSearchParams(location.search);
        let email = normalizeEmail(params.get('user') || localStorage.getItem('userEmail') || '');

        if (email && isAllowedDomain(email) && indexByEmail.has(email)) {
          await handleLogin(email);
        } else {
          renderLogin();
        }

      } catch (err) {
        loading.classList.add('hidden');
        showError('No se pudo cargar la data: ' + (err?.message || err));
      }
    })();
  </script>
</body>
</html>
