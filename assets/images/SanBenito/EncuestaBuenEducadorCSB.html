<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Consejo premio al buen educador 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --color-primary:#A7282D; --color-primary-hover:#7f1f25; }
    body{ font-family:'Inter',sans-serif }
    .toast{ visibility:hidden; min-width:250px; background:#333; color:#fff; text-align:center; border-radius:8px; padding:16px; position:fixed; z-index:60; left:50%; bottom:30px; transform:translateX(-50%); opacity:0; transition:.5s }
    .toast.show{ visibility:visible; opacity:1; bottom:50px }
    .bg-primary{ background:var(--color-primary) } .hover\:bg-primary-hover:hover{ background:var(--color-primary-hover) }
    .focus\:ring-primary:focus{ box-shadow:0 0 0 4px var(--color-primary) } .focus\:border-primary:focus{ border-color:var(--color-primary) }

    /* Overlay pantalla completa */
    .screen-busy {
      position: fixed; inset: 0; background: rgba(15, 23, 42, .35);
      display: none; align-items: center; justify-content: center; z-index: 50;
      backdrop-filter: blur(1.5px);
    }
    .screen-busy.show { display: flex; }

    /* =========================================================
       LENGÜETA (diseño carpeta) – versión sin “peek” + rebote suave
       ========================================================= */
    .help-ribbon {
      position: fixed; inset-inline: 0; bottom: 0; z-index: 40;
      pointer-events: none; /* solo elementos internos reciben eventos */
    }
    .help-shell {
      pointer-events: auto;
      margin: 0 auto; max-width: 56rem; position: relative;
      /* contenedor centrado, no afecta el layout principal */
    }

    /* Panel: completamente fuera de vista cuando está cerrado */
    .help-panel {
      position: fixed; /* fijo al viewport para controlar bien el borde */
      left: 50%; transform: translateX(-50%) translateY(100%);
      bottom: 0;
      width: min(56rem, calc(100vw - 1.5rem));
      border-top-left-radius: 1rem; border-top-right-radius: 1rem;
      box-shadow: 0 -10px 30px rgba(2,6,23,.08);
      border: 1px solid rgb(226 232 240);
      background: white;
      max-height: 60vh; overflow: hidden;
      transition: transform .28s ease;
      will-change: transform;
    }
    .help-panel.open {
      transform: translateX(-50%) translateY(0);
    }

    /* Cuerpo desplazable dentro del panel */
    .help-body {
      max-height: calc(60vh - 52px);
      overflow-y: auto;
    }

    /* Pestaña siempre visible, pegada al borde inferior de la ventana */
    .help-tab {
      position: fixed; left: 50%; bottom: 0; transform: translateX(-50%);
      background: var(--color-primary); color: white;
      border-top-left-radius: .75rem; border-top-right-radius: .75rem;
      padding: .6rem .9rem;
      display: inline-flex; align-items: center; gap: .5rem;
      box-shadow: 0 6px 14px rgba(2,6,23,.18);
      cursor: pointer; user-select: none;
      min-height: 40px;
      z-index: 41; /* encima del panel */
    }
    .help-tab:hover { background: var(--color-primary-hover); }
    .help-tab:focus { outline: none; box-shadow: 0 0 0 3px rgba(167,40,45,.25), 0 6px 14px rgba(2,6,23,.18); }
    .help-tab .chev { transition: transform .2s ease; }
    .help-tab.open .chev { transform: rotate(180deg); }

    /* Rebote suave (3 veces, con delay inicial) */
    @keyframes gentle-bounce {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      30%      { transform: translateX(-50%) translateY(-6px); }
      60%      { transform: translateX(-50%) translateY(0); }
    }
    .help-tab.tease {
      animation: gentle-bounce 1.2s ease-in-out 3 3s; /* 3 veces, empieza a los 3s */
    }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">
  <div class="container mx-auto p-4 md:p-8 max-w-3xl">
    <header class="text-center mb-8">
      <img id="logo" src="https://daniavm.github.io/assets/images/logoCSB.png" alt="Logo Institucional" class="mx-auto h-20 w-auto mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Consejo premio al buen educador 2025</h1>
      <p class="text-slate-600 mt-2">Te invitamos a participar de este importante proceso.</p>
    </header>

    <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-slate-200">
      <div id="userInfo" class="p-4 rounded-lg hidden mb-6"></div>

      <div id="loading" class="text-center p-8">
        <!-- Loader inicial -->
        <svg class="animate-spin h-8 w-8 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <p class="mt-2 font-medium">Cargando datos...</p>
      </div>

      <div id="formContainer"></div>
      <div id="softError" class="hidden mt-4 p-4 rounded-lg border border-red-200 bg-red-50 text-red-800 text-sm"></div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">¡Gracias! Tu voto ha sido registrado.</div>

  <!-- Overlay global para procesos largos -->
  <div id="busyOverlay" class="screen-busy" role="status" aria-live="polite">
    <div class="rounded-xl bg-white/90 px-6 py-5 shadow-xl border border-slate-200 text-center">
      <svg class="animate-spin h-8 w-8 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
      <p class="mt-2 text-slate-700 font-medium">Procesando…</p>
    </div>
  </div>

  <!-- Lengüeta inferior (se muestra solo para usuarios validados) -->
  <div id="helpRibbon" class="help-ribbon hidden" aria-live="polite"></div>

  <script>
    // =================== CONFIG API (JSONP) ===================
    const GAS_BASE_URL = 'https://script.google.com/macros/s/AKfycbyrh-gOhjB7JKvEsKt5QQ3IOOxeJBQmwhVjfj91TrIjPIwMKiXKlOj0BrXQuk7ZSo1G-A/exec'; // <-- tu /exec
    const API_KEY = '';               // si usas SHARED_API_KEY en Apps Script
    const ALLOWED_DOMAIN = 'colegiosanbenito.org';

    // JSONP helper
    function jsonp(url, timeoutMs = 20000) {
      return new Promise((resolve, reject) => {
        const cbName = 'jsonp_cb_' + Math.random().toString(36).slice(2);
        const script = document.createElement('script');
        const timer = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
        function cleanup(){ clearTimeout(timer); delete window[cbName]; if (script && script.parentNode) script.parentNode.removeChild(script); }
        window[cbName] = (data) => { cleanup(); resolve(data); };
        const sep = url.includes('?') ? '&' : '?';
        script.src = url + sep + 'callback=' + encodeURIComponent(cbName);
        script.onerror = () => { cleanup(); reject(new Error('JSONP error')); };
        document.head.appendChild(script);
      });
    }

    // Cliente API
    const api = {
      getSheetDataSafe() {
        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('fn','getSheetDataSafe');
        if (API_KEY) url.searchParams.set('key', API_KEY);
        return jsonp(url.toString());
      },
      hasVoted(email) {
        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('fn','hasVoted');
        url.searchParams.set('email', email);
        if (API_KEY) url.searchParams.set('key', API_KEY);
        return jsonp(url.toString());
      },
      saveVote(payload) {
        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('fn','saveVote');
        url.searchParams.set('payload', JSON.stringify(payload));
        if (API_KEY) url.searchParams.set('key', API_KEY);
        return jsonp(url.toString());
      }
    };

    // =================== UI HELPERS ===================
    const formContainer = document.getElementById('formContainer');
    const loading = document.getElementById('loading');
    const userInfo = document.getElementById('userInfo');
    const softError = document.getElementById('softError');
    const toast = document.getElementById('toast');
    const busyOverlay = document.getElementById('busyOverlay');
    const helpRibbon = document.getElementById('helpRibbon');

    function showError(msg){ softError.textContent = msg || 'Ocurrió un error'; softError.classList.remove('hidden'); }
    function hideError(){ softError.classList.add('hidden'); softError.textContent = ''; }
    function showToast(msg='¡Gracias! Tu voto ha sido registrado.'){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),3000); }
    function hexToRgba(hex, a=1){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m?`rgba(${parseInt(m[1],16)}, ${parseInt(m[2],16)}, ${parseInt(m[3],16)}, ${a})`:''; }

    // Overlay global
    function setScreenBusy(on, text='Procesando…'){
      const label = busyOverlay.querySelector('p');
      if (label) label.textContent = text;
      busyOverlay.classList.toggle('show', !!on);
    }

    // Spinner en botón
    function setButtonBusy(btn, on, busyText='Enviando…'){
      if(!btn) return;
      if (on) {
        btn.dataset._orig = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = `
          <span class="inline-flex items-center justify-center gap-2">
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a 8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            ${busyText}
          </span>`;
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset._orig || 'Enviar';
        delete btn.dataset._orig;
      }
    }

    // ====== Reglas de subáreas válidas ======
    const PROFESSOR_SUBAREAS_SOURCE = [
      'Lenguaje','Matemática','Música','Inglés secundaria','Ciencias','Ed. Física',
      'Inglés - 1° ciclo','Preescolar','Lenguaje','Inglés - 2° ciclo','Inglés Secundaria',
      'Matemática','Historia','1°- 2° Básico','Religión y Filosofía','Preescolar','Arte'
    ];
    const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[-–—]/g,' ').replace(/\s+/g,' ').trim();
    const PROFESSOR_SUBAREAS = new Set(PROFESSOR_SUBAREAS_SOURCE.map(norm));
    const isProfessorSubarea = s => PROFESSOR_SUBAREAS.has(norm(s));

    // =================== Datos y flujo ===================
    let allData = [];      // registros
    let indexByEmail = new Map();

    function normalizeEmail(s){ return String(s||'').trim().toLowerCase(); }
    function isAllowedDomain(email){
      if(!ALLOWED_DOMAIN) return true;
      const parts = normalizeEmail(email).split('@');
      return parts.length===2 && parts[1]===ALLOWED_DOMAIN;
    }

    function calcularAntiguedad(f){
      if(!f) return 0; const p=String(f).split(/[\/\-]/); let d;
      if(p.length===3){ d = (p[0].length===4) ? new Date(p[0],p[1]-1,p[2]) : new Date(p[2],p[1]-1,p[0]); } else return 0;
      const h=new Date(); let a=h.getFullYear()-d.getFullYear(); const m=h.getMonth()-d.getMonth(); if(m<0 || (m===0 && h.getDate()<d.getDate())) a--; return a;
    }

    function processData(arr){
      return (arr||[]).map(p=>{
        const nombreCompleto = `${p.nombre||''} ${p.primerApellido||''} ${p.segundoApellido||''}`.replace(/\s+/g,' ').trim();
        let rol = 'Indefinido'; if(String(p.grupo).trim()==='2') rol='Profesor de Sala'; else if(String(p.grupo).trim()==='1') rol='Educador';
        const _excluded = !!p.noSeIncluye; // viene marcado desde el backend
        return {...p, nombreCompleto, rolCalculado:rol, _excluded};
      }).filter(p => p.nombreCompleto && p.email);
    }

    function createSelectOptions(list){
      const usable=list.filter(p=>!p._excluded);
      if(!usable.length) return '<option value="">-- No hay candidatos disponibles --</option>';
      const sorted=[...usable].sort((a,b)=>a.nombreCompleto.localeCompare(b.nombreCompleto));
      let html='<option value="">-- Selecciona una persona --</option>';
      sorted.forEach(p=> html+=`<option value="${p.email}">${p.nombreCompleto}</option>`);
      return html;
    }
    function createSelectOptionsWithSubarea(list){
      const usable=list.filter(p=>!p._excluded);
      if(!usable.length) return '<option value="">-- No hay candidatos disponibles --</option>';
      const sorted=[...usable].sort((a,b)=>{
        const A=String(a.departamento||'').toLowerCase(), B=String(b.departamento||'').toLowerCase();
        if(A<B) return -1; if(A>B) return 1; return a.nombreCompleto.localeCompare(b.nombreCompleto);
      });
      let html='<option value="">-- Selecciona una persona --</option>';
      sorted.forEach(p=> html+=`<option value="${p.email}">${p.departamento||'(Sin subárea)'} — ${p.nombreCompleto}</option>`);
      return html;
    }

    function renderSuccessCard(nombre){
      formContainer.innerHTML = `
        <div class="text-center p-8 border-2 border-dashed border-emerald-200 rounded-2xl bg-emerald-50/70">
          <svg class="mx-auto mb-4 h-10 w-10 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12l2 2l4 -4m6 2a9 9 0 11-18 0a9 9 0 0118 0z"/>
          </svg>
          <h3 class="text-2xl font-semibold text-emerald-800">¡Gracias, ${nombre||'participante'}!</h3>
          <p class="text-slate-700 mt-2">Tu respuesta fue enviada correctamente.</p>
        </div>`;
    }

    /* ================== NUEVA LENGÜETA ================== */
    function buildHelpRibbon() {
      if (!helpRibbon) return;
      if (helpRibbon.dataset.ready === '1') {
        helpRibbon.classList.remove('hidden');
        return;
      }

      // Estructura: tab fija abajo + panel fijo que sube desde abajo
      helpRibbon.innerHTML = `
        <div class="help-shell">
          <button id="helpToggle" class="help-tab tease" type="button" aria-controls="helpPanel" aria-label="Abrir ayuda">
            <svg class="chev h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M10.75 3.5a.75.75 0 00-1.5 0v9.19L6.3 9.74a.75.75 0 10-1.06 1.06l4.25 4.25a.75.75 0 001.06 0l4.25-4.25a.75.75 0 10-1.06-1.06l-2.95 2.95V3.5z"/>
            </svg>
            <span class="text-sm font-medium">¿Cómo elegir?</span>
          </button>

          <section class="help-panel" id="helpPanel" aria-hidden="true">
            <div class="help-body px-4 sm:px-6 pt-4 pb-5">
              <div class="prose prose-sm max-w-none">
                <p class="text-slate-700">
                  <strong>Día del Educador 2025.</strong> Distinguiremos a quienes viven su vocación formando a nuestros niños y jóvenes.
                </p>
                <h4 class="text-slate-900 font-semibold mt-3">¿A quiénes distinguiremos?</h4>
                <ul class="list-disc pl-5 text-slate-700">
                  <li>Un <strong>buen profesor</strong> en <em>Primer Ciclo</em> (PK a 2° básico).</li>
                  <li>Dos <strong>buenos profesores</strong> de <em>Segundo, Tercer y Cuarto Ciclo</em> (3º básico a IVº medio).</li>
                  <li>Un <strong>buen educador</strong> que forma sin dictar clases formalmente.</li>
                </ul>

                <p class="mt-3 text-slate-700">Se consideran las últimas evaluaciones de desempeño, las características del educador Manquehuino y, siguiendo a San Benito, el consejo de la comunidad.</p>

                <h4 class="text-slate-900 font-semibold mt-3">Buscamos educadores que…</h4>
                <ul class="list-disc pl-5 text-slate-700">
                  <li><strong>Valoren el conocimiento y la mejora continua</strong>
                    <ul class="list-disc pl-5">
                      <li>Cultiven la excelencia profesional.</li>
                      <li>Se actualicen, reflexionen e innoven.</li>
                      <li>Promuevan el trabajo bien hecho.</li>
                    </ul>
                  </li>
                  <li class="mt-2"><strong>Ejerzan liderazgo pedagógico</strong>
                    <ul class="list-disc pl-5">
                      <li>Autoridad como servicio a los alumnos.</li>
                      <li>Motiven dando sentido al aprendizaje.</li>
                    </ul>
                  </li>
                  <li class="mt-2"><strong>Gestionen buscando el logro</strong>
                    <ul class="list-disc pl-5">
                      <li>Movilicen lo cognitivo, social y valórico.</li>
                      <li>Sean proactivos, ordenados y responsables.</li>
                    </ul>
                  </li>
                  <li class="mt-2"><strong>Promuevan la vida comunitaria y el trabajo colaborativo</strong>
                    <ul class="list-disc pl-5">
                      <li>Sean factor de unión en su equipo.</li>
                      <li>Participen en actividades de la comunidad.</li>
                      <li>Asuman los desafíos académicos y formativos del colegio.</li>
                    </ul>
                  </li>
                  <li class="mt-2"><strong>Trayectoria destacada</strong> en los últimos cinco años.</li>
                </ul>

                <p class="mt-3 text-slate-700">
                  Este formulario estará abierto hasta el <strong>viernes 7 de octubre</strong>.
                </p>
              </div>
            </div>
          </section>
        </div>
      `;

      const panel  = document.getElementById('helpPanel');
      const toggle = document.getElementById('helpToggle');

      function openPanel(open) {
        panel.classList.toggle('open', open);
        toggle.classList.toggle('open', open);
        panel.setAttribute('aria-hidden', open ? 'false' : 'true');
        // al abrir una vez, quitamos el “tease” para no molestar
        if (open) toggle.classList.remove('tease');
      }
      function togglePanel() { openPanel(!panel.classList.contains('open')); }

      toggle.addEventListener('click', togglePanel);
      toggle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); togglePanel(); }
      });

      helpRibbon.classList.remove('hidden');
      helpRibbon.dataset.ready = '1';
    }
    /* ================== FIN LENGÜETA ================== */

    function renderVotingForm(currentUser, userRole){
      // Mostrar la lengüeta de ayuda (solo usuarios válidos)
      buildHelpRibbon();

      const isMe = p => normalizeEmail(p.email)===normalizeEmail(currentUser.email);
      const elegible = allData.filter(p=> calcularAntiguedad(p.fechaIngreso)>=5 && !isMe(p) && !p._excluded);
      const profesores = elegible.filter(p=> p.rolCalculado==='Profesor de Sala' && isProfessorSubarea(p.departamento));
      const educadores = elegible.filter(p=> p.rolCalculado==='Educador');

      let html = '<form id="recognitionForm" class="space-y-6">';
      if(userRole==='Profesor'){
        const myDept = norm(currentUser.departamento);
        const mismos = profesores.filter(p=> norm(p.departamento)===myDept);
        const otros  = profesores.filter(p=> norm(p.departamento)!==myDept);
        html += `
          <div class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50/80">
            <p class="text-md font-semibold text-slate-800">Pregunta 1: Votación por Profesores</p>
            <div class="pl-2 border-l-4 border-primary/50 pt-1">
              <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-primary mr-1">1a.</strong>Profesor de tu departamento</label>
              <select name="vote1" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptions(mismos)}</select>
            </div>
            <div class="pl-2 border-l-4 border-primary/50 pt-1">
              <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-primary mr-1">1b.</strong>Profesor de otro departamento</label>
              <select name="vote2" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(otros)}</select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-slate-700 mr-1">2.</strong>EDUCADOR</label>
            <select name="vote3" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(educadores)}</select>
          </div>`;
      } else {
        html += `
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-slate-700 mr-1">1.</strong>PROFESOR</label>
            <select name="vote1" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(profesores)}</select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-slate-700 mr-1">2.</strong>EDUCADOR</label>
            <select name="vote2" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(educadores)}</select>
          </div>`;
      }
      html += `<button type="submit" id="voteButton" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-hover transition">Enviar Votación</button></form>`;
      formContainer.innerHTML = html;

      indexByEmail = new Map(allData.map(p=>[normalizeEmail(p.email), p]));

      document.getElementById('recognitionForm').addEventListener('submit', async (ev)=>{
        ev.preventDefault(); hideError();
        const f = ev.target;
        const btn = document.getElementById('voteButton');

        // Validaciones previas
        const v1 = f.vote1?.value||'', v2=f.vote2?.value||'', v3=f.vote3?.value||'';
        if(!v1 || !v2) return showError('Debes completar al menos las dos primeras selecciones.');
        const vals=[v1,v2].concat(v3?[v3]:[]); const lower=vals.map(x=>normalizeEmail(x));
        if(new Set(lower).size!==lower.length) return showError('Los votos deben ser por personas distintas.');
        if(lower.includes(normalizeEmail(currentUser.email))) return showError('No puedes votarte a ti mismo.');

        // Construcción payload
        const pick = email => { const p=indexByEmail.get(normalizeEmail(email)); return p?{name:p.nombreCompleto,email:p.email,subarea:p.departamento}:null; };
        const d1=pick(v1), d2=pick(v2), d3=v3?pick(v3):null;
        const voter = { name:currentUser.nombreCompleto, email:currentUser.email, subarea:currentUser.departamento };
        const payload = {
          votanteEmail: voter.email,
          voto1: v1, voto2: v2, voto3: v3 || null,
          voter, details: [{slot:1,...d1},{slot:2,...d2}, ...(d3?[{slot:3,...d3}]:[])]
        };

        // Busy states
        setButtonBusy(btn, true, 'Enviando…');
        setScreenBusy(true, 'Registrando tu voto…');

        try {
          const resp = await api.saveVote(payload);
          if (!resp || resp.ok !== true) throw new Error(resp?.error || 'No se pudo guardar');
          showToast('¡Gracias! Tu voto ha sido registrado.');
          renderSuccessCard(voter.name); // oculta el formulario
        } catch (err) {
          showError('Error al guardar: ' + (err?.message || err));
          setButtonBusy(btn, false);
        } finally {
          setScreenBusy(false);
        }
      });
    }

    function renderLogin() {
      loading.classList.add('hidden');
      formContainer.innerHTML = `
        <div class="p-6 sm:p-8 rounded-2xl border border-slate-200 bg-white">
          <h3 class="text-xl font-semibold text-slate-900">Identifícate para votar</h3>
          <p class="text-slate-600 mt-2">Usa tu correo institucional para validar que estás en la lista.</p>

          <form id="loginForm" class="mt-6 space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Correo institucional</label>
              <input type="email" name="email" required placeholder="tucorreo@${ALLOWED_DOMAIN||'tu-dominio'}"
                class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" />
            </div>
            <button id="loginBtn" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-hover transition">Continuar</button>
          </form>
          <div id="loginError" class="hidden mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-3"></div>
        </div>
      `;

      const form = document.getElementById('loginForm');
      const err  = document.getElementById('loginError');
      const btn  = document.getElementById('loginBtn');

      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault(); hideError(); err.classList.add('hidden'); err.textContent='';
        const email = normalizeEmail(new FormData(form).get('email')||'');

        try {
          // Busy mientras validamos y consultamos “hasVoted”
          setButtonBusy(btn, true, 'Verificando…');
          setScreenBusy(true, 'Verificando acceso…');
          await handleLogin(email);
        } catch (e){
          err.textContent = e?.message || 'No se pudo validar tu correo.';
          err.classList.remove('hidden');
        } finally {
          setButtonBusy(btn, false);
          setScreenBusy(false);
        }
      });
    }

    async function handleLogin(email){
      if(!email) throw new Error('Ingresa un correo.');
      if(!isAllowedDomain(email)) throw new Error(`Debe ser @${ALLOWED_DOMAIN}.`);

      const me = allData.find(p => normalizeEmail(p.email) === email);
      if(!me){
        throw new Error(`Tu correo (${email}) no aparece en la lista.`);
      }

      localStorage.setItem('userEmail', email);

      userInfo.innerHTML = `<p><strong>Votando como:</strong> ${me.nombreCompleto} <span class="text-slate-500">(${me.email})</span></p>`;
      userInfo.style.backgroundColor = hexToRgba('#A7282D',0.08);
      userInfo.style.color = '#7f1f25';
      userInfo.classList.remove('hidden');

      // Activar lengüeta de ayuda para usuarios válidos
      buildHelpRibbon();

      // ¿Ya votó?
      setScreenBusy(true, 'Comprobando estado de tu voto…');
      try {
        const info = await api.hasVoted(email);
        if (info && info.voted) {
          formContainer.innerHTML = `
            <div class="text-center p-8 border-2 border-dashed border-emerald-200 rounded-lg bg-emerald-50/70">
              <h3 class="text-xl font-semibold text-emerald-800">¡Gracias!</h3>
              <p class="text-slate-700 mt-2">Ya registraste un voto el <strong>${info.lastAt}</strong>.</p>
            </div>`;
        } else {
          promptForRole(me);
        }
      } catch {
        // si falla, seguimos con el flujo normal
        promptForRole(me);
      } finally {
        setScreenBusy(false);
      }
    }

    function promptForRole(currentUser){
      // Aseguramos que la lengüeta esté lista cuando ya sabemos que es usuario válido
      buildHelpRibbon();

      formContainer.innerHTML = `
        <div class="text-center p-8 border-2 border-dashed border-slate-200 rounded-lg">
          <h3 class="text-xl font-semibold text-slate-800 mb-6">¿Eres profesor titular de alguna asignatura?</h3>
          <div class="flex justify-center gap-4">
            <button id="answerYes" class="w-24 bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-hover">Sí</button>
            <button id="answerNo" class="w-24 bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">No</button>
          </div>
        </div>`;
      document.getElementById('answerYes').onclick = ()=>renderVotingForm(currentUser,'Profesor');
      document.getElementById('answerNo').onclick  = ()=>renderVotingForm(currentUser,'Educador');
    }

    // =================== INIT ===================
    (async function init(){
      try {
        setScreenBusy(true, 'Cargando directorio…');
        const payload = await api.getSheetDataSafe();
        if(!payload || payload.ok!==true) throw new Error(payload?.error || 'Error de carga');
        allData = processData(payload.data || []);
        indexByEmail = new Map(allData.map(p=>[normalizeEmail(p.email), p]));
        loading.classList.add('hidden');

        const params = new URLSearchParams(location.search);
        let email = normalizeEmail(params.get('user') || localStorage.getItem('userEmail') || '');

        if (email && isAllowedDomain(email) && indexByEmail.has(email)) {
          await handleLogin(email);
        } else {
          renderLogin();
        }
      } catch (err) {
        showError('No se pudo cargar la data: ' + (err?.message || err));
      } finally {
        setScreenBusy(false);
      }
    })();
  </script>
</body>
</html>
