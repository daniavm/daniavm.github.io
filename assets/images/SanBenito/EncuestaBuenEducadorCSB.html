<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Consejo premio al buen educador 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --color-primary:#A7282D; --color-primary-hover:#7f1f25; }
    body{ font-family:'Inter',sans-serif }
    .toast{ visibility:hidden; min-width:250px; background:#333; color:#fff; text-align:center; border-radius:8px; padding:16px; position:fixed; z-index:60; left:50%; bottom:30px; transform:translateX(-50%); opacity:0; transition:.5s }
    .toast.show{ visibility:visible; opacity:1; bottom:50px }
    .bg-primary{ background:var(--color-primary) } .hover\:bg-primary-hover:hover{ background:var(--color-primary-hover) }
    .focus\:ring-primary:focus{ box-shadow:0 0 0 4px var(--color-primary) } .focus\:border-primary:focus{ border-color:var(--color-primary) }

    /* Overlay pantalla completa */
    .screen-busy {
      position: fixed; inset: 0; background: rgba(15, 23, 42, .35);
      display: none; align-items: center; justify-content: center; z-index: 50;
      backdrop-filter: blur(1.5px);
    }
    .screen-busy.show { display: flex; }

    /* FAB reporte problemas */
    .fab-report {
      position: fixed; right: 16px; bottom: 18px; z-index: 55;
      display:flex; align-items:center; gap:.5rem;
      background:#fff; border:1px solid rgb(226,232,240); color:#0f172a;
      padding:.6rem .9rem; border-radius:9999px; box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -4px rgba(0,0,0,.1);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .fab-report:hover{ transform: translateY(-2px); box-shadow:0 15px 20px -3px rgba(0,0,0,.12),0 8px 10px -6px rgba(0,0,0,.12) }
    .fab-badge {
      position:absolute; top:-6px; right:-6px; background:#ef4444; color:#fff; font-size:10px; font-weight:700; border-radius:9999px; padding:.15rem .35rem; display:none;
    }
    .fab-report.attn { animation: nudge 1.6s ease-in-out infinite; }
    @keyframes nudge {
      0%,100% { transform: translateY(0) }
      10% { transform: translateY(-2px) }
      20% { transform: translateY(0) }
      30% { transform: translateY(-1px) }
      40% { transform: translateY(0) }
    }

    /* Modal reporte */
    .modal-backdrop {
      position: fixed; inset:0; background: rgba(15, 23, 42, .45);
      display:none; align-items:center; justify-content:center; z-index:70;
      backdrop-filter: blur(2px);
    }
    .modal-backdrop.show { display:flex; }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">
  <div class="container mx-auto p-4 md:p-8 max-w-3xl">
    <header class="text-center mb-8">
      <img id="logo" src="https://daniavm.github.io/assets/images/logoCSB.png" alt="Logo Institucional" class="mx-auto h-20 w-auto mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Consejo premio al buen educador 2025</h1>
      <p class="text-slate-600 mt-2">Te invitamos a participar de este importante proceso.</p>
    </header>

    <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-slate-200">
      <div id="userInfo" class="p-4 rounded-lg hidden mb-6"></div>

      <div id="loading" class="text-center p-8">
        <!-- Loader inicial -->
        <svg class="animate-spin h-8 w-8 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <p class="mt-2 font-medium">Cargando datos...</p>
      </div>

      <div id="formContainer"></div>
      <div id="softError" class="hidden mt-4 p-4 rounded-lg border border-red-200 bg-red-50 text-red-800 text-sm"></div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">¡Gracias! Tu voto ha sido registrado.</div>

  <!-- Overlay global para procesos largos -->
  <div id="busyOverlay" class="screen-busy" role="status" aria-live="polite">
    <div class="rounded-xl bg-white/90 px-6 py-5 shadow-xl border border-slate-200 text-center">
      <svg class="animate-spin h-8 w-8 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
      <p class="mt-2 text-slate-700 font-medium">Procesando…</p>
    </div>
  </div>

  <!-- FAB: Reportar problemas -->
  <button id="reportFab" type="button" class="fab-report" aria-controls="reportModal" aria-expanded="false" title="¿Problemas? Reportar">
    <span class="fab-badge" id="reportBadge">!</span>
    <svg class="h-5 w-5 text-slate-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 9.75l.041.008a.75.75 0 01.709.742v3.75a.75.75 0 01-1.5 0v-3.75a.75.75 0 01.75-.75zm.75 7.5a.75.75 0 100-1.5.75.75 0 000 1.5zM12 3a9 9 0 100 18 9 9 0 000-18z"/>
    </svg>
    <span class="text-sm font-medium">¿Problemas? Reportar</span>
  </button>

  <!-- Modal reporte -->
  <div id="reportModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
    <div class="bg-white rounded-2xl shadow-2xl w-[95%] max-w-xl border border-slate-200">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <h3 id="reportTitle" class="text-lg font-semibold text-slate-900">Reportar un problema</h3>
        <button id="reportClose" class="p-2 rounded-lg hover:bg-slate-100" aria-label="Cerrar">
          <svg class="h-5 w-5 text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="px-5 pt-4 pb-2 space-y-3">
        <p class="text-sm text-slate-600">Cuéntanos brevemente qué ocurrió. Incluiremos automáticamente datos técnicos (navegador, red, últimos errores) para ayudarte más rápido.</p>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Tu correo</label>
          <input id="reportEmail" type="email" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary"
                 placeholder="tu@colegiosanbenito.org" />
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Descripción</label>
          <textarea id="reportMessage" rows="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary"
                    placeholder="¿Qué intentabas hacer? ¿Apareció algún mensaje?"></textarea>
        </div>

        <div class="flex flex-wrap gap-3 pt-1">
          <button id="reportRetry" class="px-4 py-2 rounded-lg bg-slate-700 text-white hover:bg-slate-800">Reintentar</button>
          <button id="reportCopy"  class="px-4 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Copiar diagnóstico</button>
          <a id="reportSend" href="#" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary-hover">Enviar correo</a>
        </div>

        <details class="mt-2">
          <summary class="text-sm text-slate-600 cursor-pointer select-none">Ver diagnóstico (técnico)</summary>
          <pre id="reportPreview" class="mt-2 max-h-56 overflow-auto text-xs bg-slate-50 border border-slate-200 rounded-lg p-3"></pre>
        </details>
      </div>

      <div class="px-5 py-3 border-t border-slate-200 text-right">
        <button id="reportCloseBottom" class="px-4 py-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    /* =================== CONFIG API (JSONP) =================== */
    const GAS_BASE_URL = 'https://script.google.com/macros/s/AKfycbyrh-gOhjB7JKvEsKt5QQ3IOOxeJBQmwhVjfj91TrIjPIwMKiXKlOj0BrXQuk7ZSo1G-A/exec';
    const API_KEY = '';               // si usas SHARED_API_KEY en Apps Script
    const ALLOWED_DOMAIN = 'colegiosanbenito.org';
    const SUPPORT_EMAIL = 'dvaldes@colegiosanbenito.org'; // <--- cambia si quieres

    /* =================== JSONP helper =================== */
    function jsonp(url, timeoutMs = 20000) {
      return new Promise((resolve, reject) => {
        const cbName = 'jsonp_cb_' + Math.random().toString(36).slice(2);
        const script = document.createElement('script');
        const timer = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
        function cleanup(){ clearTimeout(timer); delete window[cbName]; if (script && script.parentNode) script.parentNode.removeChild(script); }
        window[cbName] = (data) => { cleanup(); resolve(data); };
        const sep = url.includes('?') ? '&' : '?';
        script.src = url + sep + 'callback=' + encodeURIComponent(cbName);
        script.onerror = () => { cleanup(); reject(new Error('JSONP error')); };
        document.head.appendChild(script);
      });
    }

    /* =================== API Client =================== */
    const api = {
      getSheetDataSafe() {
        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('fn','getSheetDataSafe');
        if (API_KEY) url.searchParams.set('key', API_KEY);
        return jsonp(url.toString());
      },
      hasVoted(email) {
        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('fn','hasVoted');
        url.searchParams.set('email', email);
        if (API_KEY) url.searchParams.set('key', API_KEY);
        return jsonp(url.toString());
      },
      saveVote(payload) {
        const url = new URL(GAS_BASE_URL);
        url.searchParams.set('fn','saveVote');
        url.searchParams.set('payload', JSON.stringify(payload));
        if (API_KEY) url.searchParams.set('key', API_KEY);
        return jsonp(url.toString());
      }
    };

    /* =================== UI HELPERS =================== */
    const formContainer = document.getElementById('formContainer');
    const loading = document.getElementById('loading');
    const userInfo = document.getElementById('userInfo');
    const softError = document.getElementById('softError');
    const toast = document.getElementById('toast');
    const busyOverlay = document.getElementById('busyOverlay');

    function showError(msg){ softError.textContent = msg || 'Ocurrió un error'; softError.classList.remove('hidden'); logErr('UI.showError', msg); pulseReportFab(); }
    function hideError(){ softError.classList.add('hidden'); softError.textContent = ''; }
    function showToast(msg='¡Gracias! Tu voto ha sido registrado.'){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),3000); }
    function hexToRgba(hex, a=1){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m?`rgba(${parseInt(m[1],16)}, ${parseInt(m[2],16)}, ${parseInt(m[3],16)}, ${a})`:''; }

    // Overlay global
    function setScreenBusy(on, text='Procesando…'){
      const label = busyOverlay.querySelector('p');
      if (label) label.textContent = text;
      busyOverlay.classList.toggle('show', !!on);
    }

    // Spinner en botón
    function setButtonBusy(btn, on, busyText='Enviando…'){
      if(!btn) return;
      if (on) {
        btn.dataset._orig = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = `
          <span class="inline-flex items-center justify-center gap-2">
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
            ${busyText}
          </span>`;
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset._orig || 'Enviar';
        delete btn.dataset._orig;
      }
    }

    // ====== Reglas de subáreas válidas ======
    const PROFESSOR_SUBAREAS_SOURCE = [
      'Lenguaje','Matemática','Música','Inglés secundaria','Ciencias','Ed. Física',
      'Inglés - 1° ciclo','Preescolar','Lenguaje','Inglés - 2° ciclo','Inglés Secundaria',
      'Matemática','Historia','1°- 2° Básico','Religión y Filosofía','Preescolar','Arte'
    ];
    const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[-–—]/g,' ').replace(/\s+/g,' ').trim();
    const PROFESSOR_SUBAREAS = new Set(PROFESSOR_SUBAREAS_SOURCE.map(norm));
    const isProfessorSubarea = s => PROFESSOR_SUBAREAS.has(norm(s));

    /* =================== DIAGNÓSTICO & REPORTE =================== */
    const reportFab = document.getElementById('reportFab');
    const reportBadge = document.getElementById('reportBadge');
    const reportModal = document.getElementById('reportModal');
    const reportClose = document.getElementById('reportClose');
    const reportCloseBottom = document.getElementById('reportCloseBottom');
    const reportEmail = document.getElementById('reportEmail');
    const reportMsg = document.getElementById('reportMessage');
    const reportPreview = document.getElementById('reportPreview');
    const btnRetry = document.getElementById('reportRetry');
    const btnCopy = document.getElementById('reportCopy');
    const btnSend = document.getElementById('reportSend');

    const ERROR_BUFFER_MAX = 20;
    const errorLog = []; // { ts, type, where, message, extra }

    function logErr(where, err, extra={}) {
      const entry = {
        ts: new Date().toISOString(),
        type: 'error',
        where: String(where||''),
        message: (err && err.message) ? String(err.message) : String(err||''),
        extra
      };
      errorLog.push(entry);
      if (errorLog.length > ERROR_BUFFER_MAX) errorLog.shift();
      // señal para el FAB
      reportBadge.style.display = 'inline-block';
      reportFab.classList.add('attn');
    }

    // Captura global de errores JS
    window.addEventListener('error', (e)=> logErr('window.error', e?.error || e?.message || 'Error', {filename:e?.filename, lineno:e?.lineno, colno:e?.colno}));
    window.addEventListener('unhandledrejection', (e)=> logErr('unhandledrejection', e?.reason || 'Promise rejection'));

    function pulseReportFab() {
      // pequeño pulso visual si hay error
      reportFab.classList.add('attn');
      setTimeout(()=> reportFab.classList.remove('attn'), 2000);
    }

    function normalizeEmail(s){ return String(s||'').trim().toLowerCase(); }
    function isAllowedDomain(email){
      if(!ALLOWED_DOMAIN) return true;
      const parts = normalizeEmail(email).split('@');
      return parts.length===2 && parts[1]===ALLOWED_DOMAIN;
    }

    function getUserEmailCached(){
      const q = new URLSearchParams(location.search).get('user') || '';
      if (q) return q.trim();
      const saved = localStorage.getItem('userEmail') || '';
      return saved.trim();
    }

    function buildDiagnostics() {
      const env = {
        url: location.href,
        online: navigator.onLine,
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        time: new Date().toString(),
        gasBaseUrl: GAS_BASE_URL,
        allowedDomain: ALLOWED_DOMAIN,
        apiKeySet: !!API_KEY,
        emailCached: getUserEmailCached(),
      };
      const snapshot = {
        env,
        lastErrors: errorLog.slice(-10),
      };
      return JSON.stringify(snapshot, null, 2);
    }

    function openReportModal() {
      reportEmail.value = getUserEmailCached();
      reportPreview.textContent = buildDiagnostics();
      reportModal.classList.add('show');
      reportFab.setAttribute('aria-expanded','true');
    }
    function closeReportModal() {
      reportModal.classList.remove('show');
      reportFab.setAttribute('aria-expanded','false');
    }

    async function copyDiagnostics() {
      const text = `Diagnóstico técnico:\n\n${buildDiagnostics()}`;
      try {
        await navigator.clipboard.writeText(text);
        showToast('Diagnóstico copiado');
      } catch {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); showToast('Diagnóstico copiado'); } catch {}
        document.body.removeChild(ta);
      }
    }

    function sendEmailReport() {
      const to = encodeURIComponent(SUPPORT_EMAIL);
      const subject = encodeURIComponent('Reporte de problema – Consejo Buen Educador 2025');
      const user = (reportEmail.value || getUserEmailCached() || '(sin correo)').trim();
      const desc = (reportMsg.value || '(sin descripción)').trim();
      const body = encodeURIComponent(
        `Correo del usuario: ${user}\n` +
        `Descripción:\n${desc}\n\n` +
        `---\n${buildDiagnostics()}`
      );
      const mailto = `mailto:${to}?subject=${subject}&body=${body}`;
      btnSend.setAttribute('href', mailto);
    }

    // Eventos del report modal
    reportFab.addEventListener('click', openReportModal);
    reportClose.addEventListener('click', closeReportModal);
    reportCloseBottom.addEventListener('click', closeReportModal);
    btnRetry.addEventListener('click', ()=> location.reload());
    btnCopy.addEventListener('click', copyDiagnostics);
    btnSend.addEventListener('click', sendEmailReport);

    /* =================== Datos y flujo (lo tuyo, intacto) =================== */
    let allData = [];      // registros
    let indexByEmail = new Map();

    function calcularAntiguedad(f){
      if(!f) return 0; const p=String(f).split(/[\/\-]/); let d;
      if(p.length===3){ d = (p[0].length===4) ? new Date(p[0],p[1]-1,p[2]) : new Date(p[2],p[1]-1,p[0]); } else return 0;
      const h=new Date(); let a=h.getFullYear()-d.getFullYear(); const m=h.getMonth()-d.getMonth(); if(m<0 || (m===0 && h.getDate()<d.getDate())) a--; return a;
    }

    function processData(arr){
      return (arr||[]).map(p=>{
        const nombreCompleto = `${p.nombre||''} ${p.primerApellido||''} ${p.segundoApellido||''}`.replace(/\s+/g,' ').trim();
        let rol = 'Indefinido'; if(String(p.grupo).trim()==='2') rol='Profesor de Sala'; else if(String(p.grupo).trim()==='1') rol='Educador';
        const _excluded = !!p.noSeIncluye; // viene marcado desde el backend
        return {...p, nombreCompleto, rolCalculado:rol, _excluded};
      }).filter(p => p.nombreCompleto && p.email);
    }

    function createSelectOptions(list){
      const usable=list.filter(p=>!p._excluded);
      if(!usable.length) return '<option value="">-- No hay candidatos disponibles --</option>';
      const sorted=[...usable].sort((a,b)=>a.nombreCompleto.localeCompare(b.nombreCompleto));
      let html='<option value="">-- Selecciona una persona --</option>';
      sorted.forEach(p=> html+=`<option value="${p.email}">${p.nombreCompleto}</option>`);
      return html;
    }

    function createSelectOptionsWithSubarea(list){
      const usable=list.filter(p=>!p._excluded);
      if(!usable.length) return '<option value="">-- No hay candidatos disponibles --</option>';
      const sorted=[...usable].sort((a,b)=>{
        const A=String(a.departamento||'').toLowerCase(), B=String(b.departamento||'').toLowerCase();
        if(A<B) return -1; if(A>B) return 1; return a.nombreCompleto.localeCompare(b.nombreCompleto);
      });
      let html='<option value="">-- Selecciona una persona --</option>';
      sorted.forEach(p=> html+=`<option value="${p.email}">${p.departamento||'(Sin subárea)'} — ${p.nombreCompleto}</option>`);
      return html;
    }

    function renderSuccessCard(nombre){
      formContainer.innerHTML = `
        <div class="text-center p-8 border-2 border-dashed border-emerald-200 rounded-2xl bg-emerald-50/70">
          <svg class="mx-auto mb-4 h-10 w-10 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12l2 2l4 -4m6 2a9 9 0 11-18 0a9 9 0 0118 0z"/>
          </svg>
          <h3 class="text-2xl font-semibold text-emerald-800">¡Gracias, ${nombre||'participante'}!</h3>
          <p class="text-slate-700 mt-2">Tu respuesta fue enviada correctamente.</p>
        </div>`;
    }

    function renderVotingForm(currentUser, userRole){
      const isMe = p => normalizeEmail(p.email)===normalizeEmail(currentUser.email);
      const elegible = allData.filter(p=> calcularAntiguedad(p.fechaIngreso)>=5 && !isMe(p) && !p._excluded);
      const profesores = elegible.filter(p=> p.rolCalculado==='Profesor de Sala' && isProfessorSubarea(p.departamento));
      const educadores = elegible.filter(p=> p.rolCalculado==='Educador');

      let html = '<form id="recognitionForm" class="space-y-6">';
      if(userRole==='Profesor'){
        const myDept = norm(currentUser.departamento);
        const mismos = profesores.filter(p=> norm(p.departamento)===myDept);
        const otros  = profesores.filter(p=> norm(p.departamento)!==myDept);
        html += `
          <div class="space-y-4 p-4 border border-slate-200 rounded-lg bg-slate-50/80">
            <p class="text-md font-semibold text-slate-800">Pregunta 1: Votación por Profesores</p>
            <div class="pl-2 border-l-4 border-primary/50 pt-1">
              <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-primary mr-1">1a.</strong>Profesor de tu departamento</label>
              <select name="vote1" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptions(mismos)}</select>
            </div>
            <div class="pl-2 border-l-4 border-primary/50 pt-1">
              <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-primary mr-1">1b.</strong>Profesor de otro departamento</label>
              <select name="vote2" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(otros)}</select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-slate-700 mr-1">2.</strong>EDUCADOR</label>
            <select name="vote3" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(educadores)}</select>
          </div>`;
      } else {
        html += `
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-slate-700 mr-1">1.</strong>PROFESOR</label>
            <select name="vote1" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(profesores)}</select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2"><strong class="font-bold text-slate-700 mr-1">2.</strong>EDUCADOR</label>
            <select name="vote2" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" required>${createSelectOptionsWithSubarea(educadores)}</select>
          </div>`;
      }
      html += `<button type="submit" id="voteButton" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-hover transition">Enviar Votación</button></form>`;
      formContainer.innerHTML = html;

      indexByEmail = new Map(allData.map(p=>[normalizeEmail(p.email), p]));

      document.getElementById('recognitionForm').addEventListener('submit', async (ev)=>{
        ev.preventDefault(); hideError();
        const f = ev.target;
        const btn = document.getElementById('voteButton');

        // Validaciones previas
        const v1 = f.vote1?.value||'', v2=f.vote2?.value||'', v3=f.vote3?.value||'';
        if(!v1 || !v2) { showError('Debes completar al menos las dos primeras selecciones.'); return; }
        const vals=[v1,v2].concat(v3?[v3]:[]); const lower=vals.map(x=>normalizeEmail(x));
        if(new Set(lower).size!==lower.length) { showError('Los votos deben ser por personas distintas.'); return; }
        if(lower.includes(normalizeEmail(currentUser.email))) { showError('No puedes votarte a ti mismo.'); return; }

        // Construcción payload
        const pick = email => { const p=indexByEmail.get(normalizeEmail(email)); return p?{name:p.nombreCompleto,email:p.email,subarea:p.departamento}:null; };
        const d1=pick(v1), d2=pick(v2), d3=v3?pick(v3):null;
        const voter = { name:currentUser.nombreCompleto, email:currentUser.email, subarea:currentUser.departamento };
        const payload = {
          votanteEmail: voter.email,
          voto1: v1, voto2: v2, voto3: v3 || null,
          voter, details: [{slot:1,...d1},{slot:2,...d2}, ...(d3?[{slot:3,...d3}]:[])]
        };

        // Busy states
        setButtonBusy(btn, true, 'Enviando…');
        setScreenBusy(true, 'Registrando tu voto…');

        try {
          const resp = await api.saveVote(payload);
          if (!resp || resp.ok !== true) throw new Error(resp?.error || 'No se pudo guardar');
          showToast('¡Gracias! Tu voto ha sido registrado.');
          renderSuccessCard(voter.name); // oculta el formulario
        } catch (err) {
          logErr('api.saveVote', err, {payloadLight:{voter:voter.email, v1:v1, v2:v2, v3:!!v3}});
          showError('Error al guardar: ' + (err?.message || err));
          setButtonBusy(btn, false);
        } finally {
          setScreenBusy(false);
        }
      });
    }

    function renderLogin() {
      loading.classList.add('hidden');
      formContainer.innerHTML = `
        <div class="p-6 sm:p-8 rounded-2xl border border-slate-200 bg-white">
          <h3 class="text-xl font-semibold text-slate-900">Identifícate para votar</h3>
          <p class="text-slate-600 mt-2">Usa tu correo institucional para validar que estás en la lista.</p>

          <form id="loginForm" class="mt-6 space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Correo institucional</label>
              <input type="email" name="email" required placeholder="tucorreo@${ALLOWED_DOMAIN||'tu-dominio'}"
                class="w-full p-3 border border-slate-300 rounded-lg focus:ring-primary focus:border-primary" />
            </div>
            <button id="loginBtn" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-hover transition">Continuar</button>
          </form>
          <div id="loginError" class="hidden mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-3"></div>
        </div>
      `;

      const form = document.getElementById('loginForm');
      const err  = document.getElementById('loginError');
      const btn  = document.getElementById('loginBtn');

      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault(); hideError(); err.classList.add('hidden'); err.textContent='';
        const email = normalizeEmail(new FormData(form).get('email')||'');

        try {
          // Busy mientras validamos y consultamos “hasVoted”
          setButtonBusy(btn, true, 'Verificando…');
          setScreenBusy(true, 'Verificando acceso…');
          await handleLogin(email);
        } catch (e){
          logErr('handleLogin', e, {email});
          err.textContent = e?.message || 'No se pudo validar tu correo.';
          err.classList.remove('hidden');
        } finally {
          setButtonBusy(btn, false);
          setScreenBusy(false);
        }
      });
    }

    async function handleLogin(email){
      if(!email) throw new Error('Ingresa un correo.');
      if(!isAllowedDomain(email)) throw new Error(`Debe ser @${ALLOWED_DOMAIN}.`);

      const me = allData.find(p => normalizeEmail(p.email) === email);
      if(!me){
        throw new Error(`Tu correo (${email}) no aparece en la lista.`);
      }

      localStorage.setItem('userEmail', email);

      userInfo.innerHTML = `<p><strong>Votando como:</strong> ${me.nombreCompleto} <span class="text-slate-500">(${me.email})</span></p>`;
      userInfo.style.backgroundColor = hexToRgba('#A7282D',0.08);
      userInfo.style.color = '#7f1f25';
      userInfo.classList.remove('hidden');

      // ¿Ya votó?
      setScreenBusy(true, 'Comprobando estado de tu voto…');
      try {
        const info = await api.hasVoted(email);
        if (info && info.voted) {
          formContainer.innerHTML = `
            <div class="text-center p-8 border-2 border-dashed border-emerald-200 rounded-lg bg-emerald-50/70">
              <h3 class="text-xl font-semibold text-emerald-800">¡Gracias!</h3>
              <p class="text-slate-700 mt-2">Ya registraste un voto el <strong>${info.lastAt}</strong>.</p>
            </div>`;
        } else {
          promptForRole(me);
        }
      } catch (e) {
        logErr('api.hasVoted', e, {email});
        // si falla, seguimos con el flujo normal
        promptForRole(me);
      } finally {
        setScreenBusy(false);
      }
    }

    function promptForRole(currentUser){
      formContainer.innerHTML = `
        <div class="text-center p-8 border-2 border-dashed border-slate-200 rounded-lg">
          <h3 class="text-xl font-semibold text-slate-800 mb-6">¿Eres profesor titular de alguna asignatura?</h3>
          <div class="flex justify-center gap-4">
            <button id="answerYes" class="w-24 bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-hover">Sí</button>
            <button id="answerNo" class="w-24 bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">No</button>
          </div>
        </div>`;
      document.getElementById('answerYes').onclick = ()=>renderVotingForm(currentUser,'Profesor');
      document.getElementById('answerNo').onclick  = ()=>renderVotingForm(currentUser,'Educador');
    }

    // =================== INIT ===================
    (async function init(){
      try {
        setScreenBusy(true, 'Cargando directorio…');
        const payload = await api.getSheetDataSafe();
        if(!payload || payload.ok!==true) throw new Error(payload?.error || 'Error de carga');
        allData = processData(payload.data || []);
        indexByEmail = new Map(allData.map(p=>[normalizeEmail(p.email), p]));
        loading.classList.add('hidden');

        const params = new URLSearchParams(location.search);
        let email = normalizeEmail(params.get('user') || localStorage.getItem('userEmail') || '');

        if (email && isAllowedDomain(email) && indexByEmail.has(email)) {
          await handleLogin(email);
        } else {
          renderLogin();
        }
      } catch (err) {
        logErr('api.getSheetDataSafe', err);
        loading.classList.add('hidden');
        showError('No se pudo cargar la data: ' + (err?.message || err));
      } finally {
        setScreenBusy(false);
      }
    })();
  </script>
</body>
</html>
